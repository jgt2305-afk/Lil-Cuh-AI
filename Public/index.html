<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Lil Cuh AI</title>
<link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600;700&display=swap" rel="stylesheet">
<style>
:root{--pink:#ff3b9d;--red:#ff1f3d;--bg:#0a000f;--panel:#120018;--soft:#1a0023;}
*{margin:0;padding:0;box-sizing:border-box;}
html,body{width:100%;height:100%;font-family:'Inter',sans-serif;overflow:hidden;}
body{background:radial-gradient(circle at top,#24001a,var(--bg));display:flex;justify-content:center;align-items:center;color:white;}
.app{width:95%;max-width:1000px;height:92vh;background:rgba(18,0,24,.92);border-radius:22px;box-shadow:0 0 45px rgba(255,59,157,.45);display:flex;flex-direction:column;padding:18px;}
.header{text-align:center;padding-bottom:10px;border-bottom:1px solid rgba(255,59,157,.25);flex-shrink:0;}
.header h1{margin:0 0 4px;font-size:26px;color:var(--pink);display:flex;align-items:center;justify-content:center;gap:8px;}
.status-dot{width:8px;height:8px;border-radius:50%;background:#4ade80;animation:pulse 2s infinite;}
@keyframes pulse{0%,100%{opacity:1;}50%{opacity:.5;}}
.header p{margin:0;font-size:13px;opacity:.7;}
.controls{display:flex;gap:8px;justify-content:center;margin-top:8px;flex-wrap:wrap;}
.controls button{padding:6px 12px;border:1px solid rgba(255,59,157,.3);border-radius:8px;background:rgba(255,59,157,.1);color:var(--pink);font-size:11px;cursor:pointer;transition:all .2s;font-family:inherit;}
.controls button:hover{background:rgba(255,59,157,.2);transform:translateY(-1px);}
.memory-indicator{font-size:10px;opacity:.5;margin-top:4px;}
.chat{flex:1;margin-top:12px;padding:14px;background:var(--panel);border-radius:16px;overflow-y:auto;min-height:0;}
.chat::-webkit-scrollbar{width:8px;}
.chat::-webkit-scrollbar-track{background:rgba(255,59,157,.1);border-radius:4px;}
.chat::-webkit-scrollbar-thumb{background:rgba(255,59,157,.3);border-radius:4px;}
.message{max-width:75%;margin-bottom:14px;padding:12px 14px;border-radius:14px;line-height:1.5;font-size:14px;animation:slideIn .3s ease;word-wrap:break-word;}
@keyframes slideIn{from{opacity:0;transform:translateY(10px);}to{opacity:1;transform:translateY(0);}}
.user{margin-left:auto;background:linear-gradient(90deg,#1f1f1f,#121212);}
.bot{background:rgba(255,59,157,.15);border:1px solid rgba(255,59,157,.4);white-space:pre-wrap;}
.thinking{opacity:.6;font-style:italic;}
.error{background:rgba(255,31,61,.2);border:1px solid var(--red);color:#ffaaaa;}
.message-actions{display:flex;gap:6px;margin-top:8px;font-size:11px;}
.message-actions button{padding:4px 8px;border:1px solid rgba(255,59,157,.2);border-radius:6px;background:rgba(0,0,0,.3);color:rgba(255,255,255,.6);cursor:pointer;transition:all .2s;}
.message-actions button:hover{background:rgba(255,59,157,.2);color:white;}
.suggestions{display:flex;gap:6px;flex-wrap:wrap;margin-top:8px;padding:0 14px;flex-shrink:0;}
.suggestion-chip{padding:6px 12px;border:1px solid rgba(255,59,157,.2);border-radius:12px;background:rgba(255,59,157,.05);color:rgba(255,255,255,.7);font-size:12px;cursor:pointer;transition:all .2s;}
.suggestion-chip:hover{background:rgba(255,59,157,.15);border-color:rgba(255,59,157,.4);color:white;}
.input-area{display:flex;gap:10px;margin-top:10px;flex-shrink:0;}
textarea{flex:1;padding:14px;border-radius:14px;border:none;background:var(--soft);color:white;font-size:14px;resize:none;font-family:inherit;min-height:50px;max-height:120px;}
textarea::placeholder{color:rgba(255,255,255,.5);}
.send-btn{padding:14px 22px;border:none;border-radius:14px;cursor:pointer;font-weight:600;background:linear-gradient(90deg,var(--pink),var(--red));color:black;font-size:14px;}
.send-btn:disabled{opacity:.5;}
.code-panel{margin-top:10px;height:180px;background:#060008;border-radius:16px;padding:14px;overflow:auto;font-size:12px;font-family:monospace;white-space:pre-wrap;display:none;}
.code-panel.visible{display:block;}
iframe{width:100%;height:260px;margin-top:10px;border-radius:16px;border:1px solid rgba(255,59,157,.4);background:white;display:none;}
iframe.visible{display:block;}
</style>
</head>
<body>
<div class="app">
  <div class="header">
    <h1><span class="status-dot"></span> Lil Cuh AI</h1>
    <p>Ultra-intelligent: Coding + Health + Master Chef + Vision AI</p>
    <div class="controls">
      <button id="clearMemBtn">Clear Memory</button>
      <button id="showMemBtn">Show Memory</button>
      <button id="exportBtn">Export Code</button>
      <button id="newProjBtn">New Project</button>
    </div>
    <div class="memory-indicator" id="memoryIndicator">Memory: 0 projects tracked</div>
  </div>
  <div id="chat" class="chat"></div>
  <div id="suggestions" class="suggestions"></div>
  <div class="input-area">
    <textarea id="input" placeholder="Tell me what you want to build..."></textarea>
    <button id="sendBtn" class="send-btn">Send</button>
  </div>
  <div id="codePanel" class="code-panel"><div id="codeContent"></div></div>
  <iframe id="preview" sandbox="allow-scripts allow-same-origin"></iframe>
</div>

<script>
let conversationHistory = [];
let projectMemory = [];
let currentProject = null;
let isProcessing = false;

const chat = document.getElementById('chat');
const input = document.getElementById('input');
const sendBtn = document.getElementById('sendBtn');
const suggestions = document.getElementById('suggestions');
const memoryIndicator = document.getElementById('memoryIndicator');
const codePanel = document.getElementById('codePanel');
const codeContent = document.getElementById('codeContent');
const preview = document.getElementById('preview');

function addMessage(text, type, actions) {
  const div = document.createElement('div');
  div.className = 'message ' + type;
  div.textContent = text;
  
  if (actions && actions.length) {
    const actionsDiv = document.createElement('div');
    actionsDiv.className = 'message-actions';
    actions.forEach(a => {
      const btn = document.createElement('button');
      btn.textContent = a.label;
      btn.onclick = a.handler;
      actionsDiv.appendChild(btn);
    });
    div.appendChild(actionsDiv);
  }
  
  chat.appendChild(div);
  chat.scrollTop = chat.scrollHeight;
  return div;
}

function showThinking() {
  return addMessage('Thinking...', 'bot thinking');
}

function removeMessage(el) {
  if (el && el.parentNode) el.parentNode.removeChild(el);
}

function showSuggestions(sug) {
  suggestions.innerHTML = '';
  sug.forEach(s => {
    const chip = document.createElement('div');
    chip.className = 'suggestion-chip';
    chip.textContent = s;
    chip.onclick = () => {
      input.value = s;
      send();
    };
    suggestions.appendChild(chip);
  });
}

function updateMemory() {
  memoryIndicator.textContent = `Memory: ${projectMemory.length} projects tracked`;
}

function saveProject(name, code, desc) {
  const project = { id: Date.now(), name, code, description: desc, created: new Date().toISOString() };
  currentProject = project;
  const idx = projectMemory.findIndex(p => p.name === name);
  if (idx >= 0) {
    projectMemory[idx] = project;
  } else {
    projectMemory.push(project);
    if (projectMemory.length > 10) projectMemory.shift();
  }
  updateMemory();
}

function extractProjectName(msg) {
  const match = msg.match(/(?:make|build|create|design)\s+(?:a|an|me)?\s*(.+?)(?:\s+for|\s+with|\s+that|$)/i);
  return match && match[1] ? match[1].trim().substring(0, 30) : null;
}

function buildContext() {
  let ctx = '';
  if (currentProject) ctx += `\n\nCURRENT PROJECT: ${currentProject.name}\n${currentProject.description}`;
  if (projectMemory.length) ctx += `\n\nPREVIOUS PROJECTS: ${projectMemory.map(p => p.name).join(', ')}`;
  return ctx;
}

function runPreview(code) {
  preview.srcdoc = code;
  preview.classList.add('visible');
  codeContent.textContent = code;
  codePanel.classList.add('visible');
}

async function send() {
  const text = input.value.trim();
  if (!text || isProcessing) return;

  isProcessing = true;
  input.disabled = true;
  sendBtn.disabled = true;
  
  addMessage(text, 'user');
  input.value = '';
  
  const thinking = showThinking();

  try {
    conversationHistory.push({ role: 'user', content: text });

    const response = await fetch('/api/chat', {
      method: 'POST',
      headers: { 'Content-Type': 'application/json' },
      body: JSON.stringify({
        system: `You are Lil Cuh, ultra-intelligent AI expert in coding, health, fitness, medical diagnosis, culinary arts (1000+ recipes). Casual but expert-level.

CRITICAL: For code/build requests, respond ONLY with complete HTML. No explanations.

For recipes: full recipe with ingredients, steps, times, tips.
For health: ask questions, advice with disclaimers.${buildContext()}`,
        messages: conversationHistory,
        max_tokens: 4096
      })
    });

    if (!response.ok) {
      throw new Error(`API error ${response.status}`);
    }

    const data = await response.json();
    removeMessage(thinking);

    if (data.content && data.content[0]) {
      const reply = data.content[0].text;
      conversationHistory.push({ role: 'assistant', content: reply });

      const isCode = reply.trim().startsWith('<!DOCTYPE') || 
                     reply.trim().startsWith('<html') || 
                     reply.includes('```html');

      if (isCode) {
        let code = reply.replace(/```html\n?/gi, '').replace(/```\n?/g, '');
        const match = code.match(/(<!DOCTYPE[\s\S]*<\/html>)/i) || code.match(/(<html[\s\S]*<\/html>)/i);
        if (match) code = match[1];
        
        const name = extractProjectName(text) || `Project_${Date.now()}`;
        saveProject(name, code.trim(), text);
        
        addMessage('Here you go!', 'bot', [
          { label: 'Modify', handler: () => { input.value = 'modify this: '; input.focus(); }},
          { label: 'Save', handler: exportCode }
        ]);
        runPreview(code.trim());
      } else {
        addMessage(reply, 'bot');
      }
    }

  } catch (err) {
    removeMessage(thinking);
    console.error('Error:', err);
    addMessage(`Error: ${err.message}`, 'error');
  } finally {
    isProcessing = false;
    input.disabled = false;
    sendBtn.disabled = false;
    input.focus();
  }
}

function exportCode() {
  if (!currentProject) {
    addMessage('No code to export!', 'error');
    return;
  }
  const blob = new Blob([currentProject.code], {type: 'text/html'});
  const url = URL.createObjectURL(blob);
  const a = document.createElement('a');
  a.href = url;
  a.download = `${currentProject.name.replace(/\s+/g, '_')}.html`;
  a.click();
  URL.revokeObjectURL(url);
  addMessage('Exported!', 'bot');
}

function clearMemory() {
  if (confirm('Clear all memory?')) {
    projectMemory = [];
    currentProject = null;
    conversationHistory = [];
    updateMemory();
    addMessage('Memory cleared!', 'bot');
  }
}

function showMemory() {
  if (!projectMemory.length) {
    addMessage('No projects yet!', 'bot');
    return;
  }
  const msg = 'Your projects:\n\n' + projectMemory.map((p, i) => `${i+1}. ${p.name}`).join('\n');
  const actions = projectMemory.slice(-3).map(p => ({
    label: p.name.substring(0, 18),
    handler: () => {
      runPreview(p.code);
      currentProject = p;
      addMessage(`Loaded "${p.name}"`, 'bot');
    }
  }));
  addMessage(msg, 'bot', actions);
}

function newProject() {
  currentProject = null;
  conversationHistory = [];
  preview.classList.remove('visible');
  codePanel.classList.remove('visible');
  suggestions.innerHTML = '';
  addMessage('New project!', 'bot');
}

sendBtn.addEventListener('click', send);
input.addEventListener('keydown', (e) => {
  if (e.key === 'Enter' && !e.shiftKey) {
    e.preventDefault();
    send();
  }
});

document.getElementById('clearMemBtn').addEventListener('click', clearMemory);
document.getElementById('showMemBtn').addEventListener('click', showMemory);
document.getElementById('exportBtn').addEventListener('click', exportCode);
document.getElementById('newProjBtn').addEventListener('click', newProject);

addMessage('Ay! I\'m Lil Cuh - ultra-intelligent AI. I can code, give health advice, share 1000+ recipes, and more. What\'s good?', 'bot');
showSuggestions(['Build me a game', 'Recipe for tacos', 'Create workout plan']);
updateMemory();
</script>
</body>
</html>
