<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Lil Cuh AI - Enhanced</title>
<link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600;700&display=swap" rel="stylesheet">
<style>
:root{--cyan:#00ffff;--dark-cyan:#00bfbf;--deep-cyan:#008b8b;--bg:#0a0015;--panel:#0f001a;--soft:#15002a;}
*{margin:0;padding:0;box-sizing:border-box;}
html,body{width:100%;height:100%;font-family:'Inter',sans-serif;overflow:hidden;}
body{background:radial-gradient(circle at top,#001a2e,var(--bg));display:flex;justify-content:center;align-items:center;color:white;}
.app{width:95%;max-width:1100px;height:92vh;background:rgba(15,0,26,.95);border-radius:22px;box-shadow:0 0 50px rgba(0,255,255,.5),0 0 100px rgba(0,255,255,.2);display:flex;flex-direction:column;padding:18px;border:2px solid rgba(0,255,255,.3);}
.header{text-align:center;padding-bottom:12px;border-bottom:2px solid rgba(0,255,255,.3);flex-shrink:0;}
.header h1{margin:0 0 6px;font-size:28px;color:var(--cyan);display:flex;align-items:center;justify-content:center;gap:8px;text-shadow:0 0 20px rgba(0,255,255,.8);}
.status-dot{width:10px;height:10px;border-radius:50%;background:var(--cyan);animation:pulse 2s infinite;box-shadow:0 0 15px var(--cyan);}
@keyframes pulse{0%,100%{opacity:1;}50%{opacity:.5;}}
.header p{margin:0;font-size:13px;opacity:.85;color:var(--cyan);}
.controls{display:flex;gap:8px;justify-content:center;margin-top:10px;flex-wrap:wrap;}
.controls button{padding:7px 14px;border:2px solid rgba(0,255,255,.4);border-radius:10px;background:rgba(0,255,255,.15);color:var(--cyan);font-size:11px;cursor:pointer;transition:all .2s;font-family:inherit;font-weight:600;}
.controls button:hover{background:rgba(0,255,255,.3);transform:translateY(-2px);box-shadow:0 4px 15px rgba(0,255,255,.4);}
.memory-indicator{font-size:10px;opacity:.7;margin-top:6px;color:var(--cyan);}
.chat{flex:1;margin-top:12px;padding:16px;background:var(--panel);border-radius:16px;overflow-y:auto;min-height:0;border:1px solid rgba(0,255,255,.2);}
.chat::-webkit-scrollbar{width:10px;}
.chat::-webkit-scrollbar-track{background:rgba(0,255,255,.1);border-radius:5px;}
.chat::-webkit-scrollbar-thumb{background:rgba(0,255,255,.4);border-radius:5px;}
.chat::-webkit-scrollbar-thumb:hover{background:rgba(0,255,255,.6);}
.message{max-width:78%;margin-bottom:16px;padding:14px 16px;border-radius:16px;line-height:1.6;font-size:14px;animation:slideIn .3s ease;word-wrap:break-word;}
@keyframes slideIn{from{opacity:0;transform:translateY(10px);}to{opacity:1;transform:translateY(0);}}
.user{margin-left:auto;background:linear-gradient(135deg,#1a1a2e,#16213e);border:1px solid rgba(0,255,255,.2);}
.bot{
  background:rgba(0,255,255,.12);
  border:2px solid rgba(0,255,255,.4);
  white-space:pre-wrap;
  padding-left:55px;
  position:relative;
  box-shadow:0 4px 15px rgba(0,255,255,.2);
}
.bot::before{
  content:"ü§ñ";
  position:absolute;
  left:14px;
  top:50%;
  transform:translateY(-50%);
  font-size:28px;
  filter:drop-shadow(0 0 8px var(--cyan));
}
.bot.thinking::before{
  animation:iconPulse .6s ease-in-out infinite;
}
@keyframes iconPulse{
  0%, 100%{transform:translateY(-50%) scale(1);}
  50%{transform:translateY(-50%) scale(1.15);}
}
.thinking{opacity:.65;font-style:italic;}
.error{background:rgba(255,50,50,.2);border:2px solid #ff3232;color:#ffaaaa;}
.success{background:rgba(0,255,150,.15);border:2px solid #00ff96;color:#00ff96;}
.message img,.message video,.message audio{max-width:100%;border-radius:10px;margin-top:10px;display:block;border:2px solid rgba(0,255,255,.3);}
.message video{max-height:320px;}
.message audio{width:100%;}
.message-actions{display:flex;gap:6px;margin-top:10px;font-size:11px;}
.message-actions button{padding:5px 10px;border:1px solid rgba(0,255,255,.3);border-radius:8px;background:rgba(0,255,255,.1);color:var(--cyan);cursor:pointer;transition:all .2s;font-weight:600;}
.message-actions button:hover{background:rgba(0,255,255,.25);box-shadow:0 2px 10px rgba(0,255,255,.3);}
.file-preview-area{display:flex;gap:8px;flex-wrap:wrap;margin-bottom:10px;}
.file-item{padding:8px 14px;background:rgba(0,255,255,.15);border:2px solid rgba(0,255,255,.3);border-radius:10px;font-size:12px;display:flex;align-items:center;gap:8px;}
.file-item img{width:35px;height:35px;object-fit:cover;border-radius:6px;}
.file-item button{background:none;border:none;color:#ff3232;cursor:pointer;font-size:18px;padding:0;line-height:1;}
.suggestions{display:flex;gap:8px;flex-wrap:wrap;margin-top:10px;padding:0 14px;flex-shrink:0;}
.suggestion-chip{padding:7px 14px;border:2px solid rgba(0,255,255,.3);border-radius:14px;background:rgba(0,255,255,.08);color:var(--cyan);font-size:12px;cursor:pointer;transition:all .2s;font-weight:600;}
.suggestion-chip:hover{background:rgba(0,255,255,.2);border-color:rgba(0,255,255,.6);transform:translateY(-2px);box-shadow:0 4px 15px rgba(0,255,255,.3);}
.input-area{display:flex;gap:12px;margin-top:12px;flex-shrink:0;align-items:flex-end;}
.input-wrapper{flex:1;position:relative;}
textarea{width:100%;padding:16px 16px 48px 16px;border-radius:16px;border:2px solid rgba(0,255,255,.3);background:var(--soft);color:white;font-size:14px;resize:none;font-family:inherit;min-height:55px;max-height:140px;}
textarea::placeholder{color:rgba(0,255,255,.6);}
textarea:focus{outline:none;border-color:var(--cyan);box-shadow:0 0 20px rgba(0,255,255,.3);}
.input-tools{position:absolute;bottom:10px;left:10px;display:flex;gap:6px;}
.input-tools button{padding:5px 12px;border:1px solid rgba(0,255,255,.4);border-radius:8px;background:rgba(0,0,0,.6);color:var(--cyan);cursor:pointer;font-size:11px;transition:all .2s;font-weight:600;}
.input-tools button:hover{background:rgba(0,255,255,.2);box-shadow:0 0 10px rgba(0,255,255,.4);}
.send-btn{padding:16px 26px;border:none;border-radius:16px;cursor:pointer;font-weight:700;background:linear-gradient(135deg,var(--cyan),var(--deep-cyan));color:#000;font-size:15px;box-shadow:0 4px 20px rgba(0,255,255,.4);}
.send-btn:hover{transform:translateY(-2px);box-shadow:0 6px 25px rgba(0,255,255,.6);}
.send-btn:disabled{opacity:.5;transform:none;}
.code-panel{margin-top:12px;height:200px;background:#050010;border-radius:16px;padding:16px;overflow:auto;font-size:12px;font-family:monospace;white-space:pre-wrap;display:none;position:relative;border:2px solid rgba(0,255,255,.3);}
.code-panel.visible{display:block;}
.code-panel-header{position:absolute;top:12px;right:12px;display:flex;gap:6px;z-index:10;}
.code-panel-btn{padding:5px 12px;border:1px solid rgba(0,255,255,.4);border-radius:8px;background:rgba(0,0,0,.7);color:var(--cyan);cursor:pointer;font-size:11px;transition:all .2s;font-weight:600;}
.code-panel-btn:hover{background:rgba(0,255,255,.2);}
.preview-container{margin-top:12px;position:relative;display:none;}
.preview-container.visible{display:block;}
.preview-header{display:flex;justify-content:space-between;align-items:center;padding:10px 14px;background:rgba(0,255,255,.15);border:2px solid rgba(0,255,255,.4);border-radius:16px 16px 0 0;}
.preview-title{color:var(--cyan);font-size:13px;font-weight:700;text-shadow:0 0 10px rgba(0,255,255,.6);}
.preview-actions{display:flex;gap:6px;}
.preview-btn{padding:5px 12px;border:1px solid rgba(0,255,255,.4);border-radius:8px;background:rgba(0,0,0,.5);color:var(--cyan);cursor:pointer;font-size:11px;transition:all .2s;font-weight:600;}
.preview-btn:hover{background:rgba(0,255,255,.2);}
iframe{width:100%;height:280px;background:white;border:2px solid rgba(0,255,255,.4);border-top:none;border-radius:0 0 16px 16px;display:block;}
#fileInput{display:none;}
.validation-badge{display:inline-block;padding:4px 10px;border-radius:8px;font-size:10px;font-weight:700;margin-left:8px;}
.validation-badge.pass{background:rgba(0,255,150,.2);color:#00ff96;border:1px solid #00ff96;}
.validation-badge.fail{background:rgba(255,50,50,.2);color:#ff3232;border:1px solid #ff3232;}
.loading-spinner{display:inline-block;width:16px;height:16px;border:2px solid rgba(0,255,255,.3);border-top-color:var(--cyan);border-radius:50%;animation:spin 1s linear infinite;margin-left:8px;}
@keyframes spin{to{transform:rotate(360deg);}}
</style>
</head>
<body>
<div class="app">
  <div class="header">
    <h1><span class="status-dot"></span> Lil Cuh AI <span style="font-size:14px;opacity:.7;">ENHANCED</span></h1>
    <p>üöÄ Elite Code Generation | üåê Web Access | üéÆ Steam Guides | üîç Bug Checker</p>
    <div style="margin-top:14px;display:flex;flex-direction:column;align-items:center;gap:5px;">
      <div id="clock" style="font-size:30px;font-weight:700;color:var(--cyan);text-shadow:0 0 25px rgba(0,255,255,.9);letter-spacing:2px;"></div>
      <div id="date" style="font-size:13px;color:rgba(0,255,255,.9);font-weight:600;"></div>
    </div>
    <div class="controls">
      <button id="createMemoryBtn">üíæ Save Memory</button>
      <button id="loadMemoryBtn">üìÇ Load Memory</button>
      <button id="clearMemBtn">üóëÔ∏è Clear</button>
      <button id="showMemBtn">üìã Projects</button>
      <button id="exportBtn">‚¨áÔ∏è Export</button>
      <button id="newProjBtn">‚ú® New</button>
      <button id="webAccessBtn">üåê Web Access</button>
      <button id="steamGuideBtn">üéÆ Steam Guide</button>
    </div>
    <div class="memory-indicator" id="memoryIndicator">Memory: 0 projects | Features: All Active</div>
  </div>
  <div id="chat" class="chat"></div>
  <div id="suggestions" class="suggestions"></div>
  <div class="input-area">
    <div class="input-wrapper">
      <div id="filePreviewArea" class="file-preview-area"></div>
      <textarea id="input" placeholder="Ask me anything! I can code, access websites, guide you through Steam games, and more..."></textarea>
      <div class="input-tools">
        <button id="attachBtn">üìé File</button>
        <button id="genImageBtn">üé® Image</button>
        <button id="genVideoBtn">üé¨ Video</button>
        <button id="genSoundBtn">üéµ Sound</button>
      </div>
    </div>
    <button id="sendBtn" class="send-btn">Send</button>
  </div>
  <input type="file" id="fileInput" multiple accept="image/*,video/*,audio/*,.pdf,.txt,.html,.css,.js,.json,.md,.doc,.docx">
  <div id="codePanel" class="code-panel">
    <div class="code-panel-header">
      <button class="code-panel-btn" id="copyCodeBtn">üìã Copy</button>
      <button class="code-panel-btn" id="closeCodeBtn">‚úñ Close</button>
    </div>
    <div id="codeContent" style="margin-top:35px;"></div>
  </div>
  <div id="previewContainer" class="preview-container">
    <div class="preview-header">
      <div class="preview-title">üîç Live Preview</div>
      <div class="preview-actions">
        <button class="preview-btn" id="refreshPreviewBtn">üîÑ Refresh</button>
        <button class="preview-btn" id="closePreviewBtn">‚úñ Close</button>
      </div>
    </div>
    <iframe id="preview" sandbox="allow-scripts allow-same-origin"></iframe>
  </div>
</div>

<script>
let conversationHistory = [];
let projectMemory = [];
let currentProject = null;
let isProcessing = false;
let attachedFiles = [];
let userMemory = {
  name: '',
  preferences: {},
  conversationSummaries: [],
  importantFacts: [],
  projects: [],
  created: new Date().toISOString(),
  lastUpdated: new Date().toISOString()
};

const chat = document.getElementById('chat');
const input = document.getElementById('input');
const sendBtn = document.getElementById('sendBtn');
const suggestions = document.getElementById('suggestions');
const memoryIndicator = document.getElementById('memoryIndicator');
const codePanel = document.getElementById('codePanel');
const codeContent = document.getElementById('codeContent');
const previewContainer = document.getElementById('previewContainer');
const preview = document.getElementById('preview');
const fileInput = document.getElementById('fileInput');
const filePreviewArea = document.getElementById('filePreviewArea');

function addMessage(text, type, actions, mediaUrl, mediaType) {
  const div = document.createElement('div');
  div.className = 'message ' + type;
  
  if (mediaUrl && mediaType) {
    if (mediaType === 'image') {
      const img = document.createElement('img');
      img.src = mediaUrl;
      img.alt = 'Generated media';
      div.appendChild(img);
    } else if (mediaType === 'video') {
      const video = document.createElement('video');
      video.src = mediaUrl;
      video.controls = true;
      div.appendChild(video);
    } else if (mediaType === 'audio') {
      const audio = document.createElement('audio');
      audio.src = mediaUrl;
      audio.controls = true;
      div.appendChild(audio);
    }
    if (text) {
      const textDiv = document.createElement('div');
      textDiv.textContent = text;
      div.appendChild(textDiv);
    }
  } else {
    div.textContent = text;
  }
  
  if (actions && actions.length) {
    const actionsDiv = document.createElement('div');
    actionsDiv.className = 'message-actions';
    actions.forEach(a => {
      const btn = document.createElement('button');
      btn.textContent = a.label;
      btn.onclick = a.handler;
      actionsDiv.appendChild(btn);
    });
    div.appendChild(actionsDiv);
  }
  
  chat.appendChild(div);
  chat.scrollTop = chat.scrollHeight;
  return div;
}

function showThinking() {
  return addMessage('Thinking...', 'bot thinking');
}

function removeMessage(el) {
  if (el && el.parentNode) {
    el.parentNode.removeChild(el);
  }
}

function showSuggestions(sug) {
  suggestions.innerHTML = '';
  sug.forEach(s => {
    const chip = document.createElement('div');
    chip.className = 'suggestion-chip';
    chip.textContent = s;
    chip.onclick = () => {
      input.value = s;
      send();
    };
    suggestions.appendChild(chip);
  });
}

function updateMemory() {
  memoryIndicator.textContent = `Memory: ${projectMemory.length} projects | üü¢ All Systems Active`;
}

function saveProject(name, code, desc) {
  const project = { id: Date.now(), name, code, description: desc, created: new Date().toISOString() };
  currentProject = project;
  const idx = projectMemory.findIndex(p => p.name === name);
  if (idx >= 0) {
    projectMemory[idx] = project;
  } else {
    projectMemory.push(project);
    if (projectMemory.length > 15) projectMemory.shift();
  }
  updateMemory();
}

function extractProjectName(msg) {
  const match = msg.match(/(?:make|build|create|design|generate)\s+(?:a|an|me)?\s*(.+?)(?:\s+for|\s+with|\s+that|$)/i);
  return match && match[1] ? match[1].trim().substring(0, 35) : null;
}

function buildContext() {
  let ctx = '';
  if (currentProject) ctx += `\n\nCURRENT PROJECT: ${currentProject.name}\n${currentProject.description}`;
  if (projectMemory.length) ctx += `\n\nPREVIOUS PROJECTS: ${projectMemory.map(p => p.name).join(', ')}`;
  
  if (userMemory.name) ctx += `\n\nUSER: ${userMemory.name}`;
  if (Object.keys(userMemory.preferences).length > 0) {
    ctx += `\n\nPREFERENCES: ${JSON.stringify(userMemory.preferences)}`;
  }
  if (userMemory.importantFacts.length > 0) {
    ctx += `\n\nFACTS: ${userMemory.importantFacts.join(', ')}`;
  }
  
  return ctx;
}

function runPreview(code) {
  preview.srcdoc = code;
  previewContainer.classList.add('visible');
  codeContent.textContent = code;
  codePanel.classList.add('visible');
}

function closePreview() {
  previewContainer.classList.remove('visible');
  preview.srcdoc = '';
}

function closeCode() {
  codePanel.classList.remove('visible');
}

function refreshPreview() {
  if (currentProject && currentProject.code) {
    preview.srcdoc = '';
    setTimeout(() => {
      preview.srcdoc = currentProject.code;
    }, 100);
  }
}

// File handling
function fileToBase64(file) {
  return new Promise((resolve, reject) => {
    const reader = new FileReader();
    reader.onload = () => resolve(reader.result.split(',')[1]);
    reader.onerror = reject;
    reader.readAsDataURL(file);
  });
}

async function handleFiles(files) {
  for (let file of files) {
    try {
      const fileData = { name: file.name, type: file.type, size: file.size };
      
      if (file.type.startsWith('image/') || file.type.startsWith('video/') || file.type.startsWith('audio/')) {
        fileData.base64 = await fileToBase64(file);
        fileData.preview = URL.createObjectURL(file);
      } else {
        fileData.text = await file.text();
      }
      
      attachedFiles.push(fileData);
      displayFilePreview(fileData);
    } catch (e) {
      addMessage(`Error loading ${file.name}`, 'error');
    }
  }
}

function displayFilePreview(fileData) {
  const item = document.createElement('div');
  item.className = 'file-item';
  
  if (fileData.preview && fileData.type.startsWith('image/')) {
    const img = document.createElement('img');
    img.src = fileData.preview;
    item.appendChild(img);
  }
  
  const name = document.createElement('span');
  name.textContent = fileData.name;
  item.appendChild(name);
  
  const btn = document.createElement('button');
  btn.textContent = '√ó';
  btn.onclick = () => {
    attachedFiles = attachedFiles.filter(f => f.name !== fileData.name);
    filePreviewArea.innerHTML = '';
    attachedFiles.forEach(displayFilePreview);
  };
  item.appendChild(btn);
  
  filePreviewArea.appendChild(item);
}

async function generateMedia(type) {
  const prompt = input.value.trim() || `a cool ${type}`;
  input.value = '';
  
  addMessage(`Generating ${type}: "${prompt}"...`, 'bot');
  // Placeholder - actual generation would happen here
  addMessage(`Media generation coming soon! For now, try asking me to create SVG graphics, canvas animations, or Web Audio API sounds.`, 'bot');
}

// Code validation function
async function validateCode(code, language) {
  try {
    const response = await fetch('/api/validate-code', {
      method: 'POST',
      headers: { 'Content-Type': 'application/json' },
      body: JSON.stringify({ code, language })
    });
    
    if (!response.ok) throw new Error('Validation failed');
    
    const result = await response.json();
    return result;
  } catch (error) {
    console.error('Validation error:', error);
    return { isValid: false, errors: [error.message], warnings: [], suggestions: [] };
  }
}

// Web scraping function
async function scrapeWebsite(url) {
  try {
    addMessage(`üåê Scraping: ${url}`, 'bot');
    const thinking = showThinking();
    
    const response = await fetch('/api/scrape', {
      method: 'POST',
      headers: { 'Content-Type': 'application/json' },
      body: JSON.stringify({ url })
    });
    
    removeMessage(thinking);
    
    if (!response.ok) throw new Error('Scraping failed');
    
    const data = await response.json();
    
    if (data.success) {
      addMessage(`‚úÖ Successfully scraped ${(data.size / 1024).toFixed(1)} KB from ${data.url}\n\nContent preview:\n${data.textContent.substring(0, 500)}...`, 'success');
      return data.textContent;
    } else {
      throw new Error('Scraping unsuccessful');
    }
  } catch (error) {
    addMessage(`‚ùå Failed to scrape: ${error.message}`, 'error');
    return null;
  }
}

// Steam guide function
async function getSteamGuide(gameName) {
  try {
    addMessage(`üéÆ Searching for: ${gameName}`, 'bot');
    const thinking = showThinking();
    
    const response = await fetch('/api/steam-guide', {
      method: 'POST',
      headers: { 'Content-Type': 'application/json' },
      body: JSON.stringify({ gameName })
    });
    
    removeMessage(thinking);
    
    if (!response.ok) throw new Error('Guide fetch failed');
    
    const data = await response.json();
    
    if (data.found) {
      let guide = `üéÆ ${data.title}\n\n${data.content}\n\nüìö Sections available:\n${data.sections.slice(0, 8).join(', ')}\n\nüîó Full guide: ${data.url}`;
      
      if (data.relatedGames && data.relatedGames.length > 0) {
        guide += `\n\nüéØ Related games: ${data.relatedGames.join(', ')}`;
      }
      
      addMessage(guide, 'success', [
        { label: 'Open Wikipedia', handler: () => window.open(data.url, '_blank') }
      ]);
    } else {
      addMessage(`‚ùå ${data.message}`, 'error');
    }
  } catch (error) {
    addMessage(`‚ùå Failed to get guide: ${error.message}`, 'error');
  }
}

async function send() {
  const userMessage = input.value.trim();
  if (!userMessage || isProcessing) return;

  // Check for special commands
  if (userMessage.toLowerCase().startsWith('scrape ')) {
    const url = userMessage.substring(7).trim();
    await scrapeWebsite(url);
    input.value = '';
    return;
  }
  
  if (userMessage.toLowerCase().startsWith('steam ')) {
    const gameName = userMessage.substring(6).trim();
    await getSteamGuide(gameName);
    input.value = '';
    return;
  }

  isProcessing = true;
  input.value = '';
  input.disabled = true;
  sendBtn.disabled = true;

  const thinking = showThinking();
  addMessage(userMessage, 'user');

  let content = userMessage;
  let messageArray = [];

  if (attachedFiles.length > 0) {
    messageArray = attachedFiles.map(f => {
      if (f.base64 && f.type.startsWith('image/')) {
        return { type: 'image', source: { type: 'base64', media_type: f.type, data: f.base64 }};
      } else if (f.text) {
        return { type: 'text', text: `File: ${f.name}\n\n${f.text}`};
      }
    }).filter(Boolean);
    
    messageArray.push({ type: 'text', text: userMessage });
    content = messageArray;
  }

  conversationHistory.push({ role: 'user', content });

  try {
    const response = await fetch('/api/chat', {
      method: 'POST',
      headers: { 'Content-Type': 'application/json' },
      body: JSON.stringify({
        system: `You are Lil Cuh AI - an ELITE, ultra-intelligent assistant with exceptional abilities.

üî• ENHANCED CODE GENERATION RULES:
You now have access to a CODE VALIDATOR that checks your code for bugs BEFORE showing it to the user. 

WORKFLOW FOR CODE GENERATION:
1. Think through the problem carefully
2. Write clean, bug-free code with:
   - Proper error handling
   - Input validation
   - Modern best practices
   - Clear comments
   - Semantic naming
3. The validator will check it automatically
4. Explain what you built and how it works

For HTML/web apps:
- Include <!DOCTYPE html>
- Use semantic HTML5
- Modern CSS (flexbox/grid)
- Clean JavaScript (const/let, no var)
- Proper error handling

SPECIAL CAPABILITIES:
üåê WEB ACCESS: User can ask you to scrape websites with "scrape [url]"
üéÆ STEAM GUIDES: User can get game guides with "steam [game name]"
üîç CODE VALIDATION: All code is automatically validated

You can:
- Create images (SVG), videos (canvas), sounds (Web Audio API)
- Solve math problems step-by-step
- Share recipes and health advice
- Analyze uploaded files
- Build games, calculators, apps, anything!

${buildContext()}

Be helpful, thorough, and write PERFECT code every time.`,
        messages: conversationHistory,
        max_tokens: 4096
      })
    });

    if (!response.ok) {
      throw new Error(`API error ${response.status}`);
    }

    const data = await response.json();
    removeMessage(thinking);

    if (data.content && data.content[0]) {
      const reply = data.content[0].text;
      conversationHistory.push({ role: 'assistant', content: reply });

      // Check if response contains code
      const hasExplanation = reply.includes('---EXPLANATION---');
      let codepart = reply;
      let explanation = '';
      
      if (hasExplanation) {
        const parts = reply.split('---EXPLANATION---');
        codepart = parts[0].trim();
        explanation = parts[1] ? parts[1].trim() : '';
      }

      const isCode = codepart.trim().startsWith('<!DOCTYPE') || 
                     codepart.trim().startsWith('<html') || 
                     codepart.includes('```html') ||
                     codepart.includes('```javascript') ||
                     codepart.includes('```css');

      if (isCode) {
        let code = codepart.replace(/```html\n?/gi, '').replace(/```javascript\n?/gi, '').replace(/```css\n?/gi, '').replace(/```\n?/g, '');
        const match = code.match(/(<!DOCTYPE[\s\S]*<\/html>)/i) || code.match(/(<html[\s\S]*<\/html>)/i);
        if (match) code = match[1];
        
        const name = extractProjectName(userMessage) || `Project_${Date.now()}`;
        
        // Validate the code before showing it
        const validationThinking = addMessage('üîç Validating code...', 'bot thinking');
        const language = code.includes('<!DOCTYPE') || code.includes('<html') ? 'html' : 'javascript';
        const validation = await validateCode(code, language);
        removeMessage(validationThinking);
        
        // Show validation results
        let validationMsg = `üìä Code Validation:\n`;
        validationMsg += `Score: ${validation.score}/100 (Grade: ${validation.grade})\n`;
        
        if (validation.errors && validation.errors.length > 0) {
          validationMsg += `\n‚ùå Errors:\n${validation.errors.map(e => '  ‚Ä¢ ' + e).join('\n')}`;
        }
        if (validation.warnings && validation.warnings.length > 0) {
          validationMsg += `\n‚ö†Ô∏è Warnings:\n${validation.warnings.map(w => '  ‚Ä¢ ' + w).join('\n')}`;
        }
        if (validation.suggestions && validation.suggestions.length > 0) {
          validationMsg += `\nüí° Suggestions:\n${validation.suggestions.map(s => '  ‚Ä¢ ' + s).join('\n')}`;
        }
        if (validation.isValid) {
          validationMsg += '\n\n‚úÖ Code looks great!';
        }
        
        addMessage(validationMsg, validation.isValid ? 'success' : 'error');
        
        saveProject(name, code.trim(), userMessage);
        
        if (explanation) {
          addMessage(explanation, 'bot');
        }
        
        const badge = validation.isValid ? 
          '<span class="validation-badge pass">‚úì VALIDATED</span>' : 
          '<span class="validation-badge fail">‚ö† HAS ISSUES</span>';
        
        addMessage(`Code ready! ${badge}`, 'bot', [
          { label: 'üîß Modify', handler: () => { input.value = 'modify this: '; input.focus(); }},
          { label: 'üíæ Save', handler: exportCode }
        ]);
        runPreview(code.trim());
      } else {
        addMessage(reply, 'bot');
      }
    }
    
    attachedFiles = [];
    filePreviewArea.innerHTML = '';

  } catch (err) {
    removeMessage(thinking);
    console.error('Error:', err);
    addMessage(`‚ùå Error: ${err.message}`, 'error');
  } finally {
    isProcessing = false;
    input.disabled = false;
    sendBtn.disabled = false;
    input.focus();
  }
}

function exportCode() {
  if (!currentProject) {
    addMessage('No code to export!', 'error');
    return;
  }
  const blob = new Blob([currentProject.code], {type: 'text/html'});
  const url = URL.createObjectURL(blob);
  const a = document.createElement('a');
  a.href = url;
  a.download = `${currentProject.name.replace(/\s+/g, '_')}.html`;
  a.click();
  URL.revokeObjectURL(url);
  addMessage('‚úÖ Exported!', 'success');
}

function clearMemory() {
  if (confirm('Clear all memory?')) {
    projectMemory = [];
    currentProject = null;
    conversationHistory = [];
    updateMemory();
    addMessage('üóëÔ∏è Memory cleared!', 'bot');
  }
}

function showMemory() {
  if (!projectMemory.length) {
    addMessage('No projects yet!', 'bot');
    return;
  }
  const msg = 'üìã Your projects:\n\n' + projectMemory.map((p, i) => `${i+1}. ${p.name}`).join('\n');
  const actions = projectMemory.slice(-3).map(p => ({
    label: p.name.substring(0, 20),
    handler: () => {
      runPreview(p.code);
      currentProject = p;
      addMessage(`‚úÖ Loaded "${p.name}"`, 'success');
    }
  }));
  addMessage(msg, 'bot', actions);
}

function newProject() {
  currentProject = null;
  conversationHistory = [];
  closePreview();
  closeCode();
  suggestions.innerHTML = '';
  addMessage('‚ú® New project started!', 'bot');
}

function copyCode() {
  navigator.clipboard.writeText(codeContent.textContent).then(() => {
    const orig = document.getElementById('copyCodeBtn').textContent;
    document.getElementById('copyCodeBtn').textContent = '‚úì Copied!';
    setTimeout(() => document.getElementById('copyCodeBtn').textContent = orig, 2000);
  });
}

async function createMemoryFile() {
  addMessage('üíæ Creating memory file...', 'bot');
  const thinking = showThinking();
  
  try {
    const response = await fetch('/api/chat', {
      method: 'POST',
      headers: { 'Content-Type': 'application/json' },
      body: JSON.stringify({
        system: `Extract memory from conversation. Respond ONLY in JSON:
{
  "name": "user's name or empty",
  "preferences": {"key": "value"},
  "importantFacts": ["fact1", "fact2"],
  "conversationSummary": "brief summary"
}`,
        messages: conversationHistory.slice(-10),
        max_tokens: 1000
      })
    });
    
    const data = await response.json();
    removeMessage(thinking);
    
    if (data.content && data.content[0]) {
      let reply = data.content[0].text.replace(/```json\n?/g, '').replace(/```\n?/g, '').trim();
      
      try {
        const extracted = JSON.parse(reply);
        
        if (extracted.name) userMemory.name = extracted.name;
        if (extracted.preferences) userMemory.preferences = {...userMemory.preferences, ...extracted.preferences};
        if (extracted.importantFacts) userMemory.importantFacts.push(...extracted.importantFacts);
        if (extracted.conversationSummary) userMemory.conversationSummaries.push(extracted.conversationSummary);
        
        userMemory.projects = projectMemory;
        userMemory.lastUpdated = new Date().toISOString();
        
        const memoryData = JSON.stringify(userMemory, null, 2);
        const blob = new Blob([memoryData], {type: 'application/json'});
        const url = URL.createObjectURL(blob);
        const a = document.createElement('a');
        a.href = url;
        a.download = `lilcuh_memory_${Date.now()}.json`;
        a.click();
        URL.revokeObjectURL(url);
        
        addMessage(`‚úÖ Memory saved! ${userMemory.name ? `I'll remember you, ${userMemory.name}!` : 'I\'ll remember our conversation!'}\n\n- ${userMemory.importantFacts.length} facts\n- ${Object.keys(userMemory.preferences).length} preferences\n- ${userMemory.conversationSummaries.length} summaries`, 'success');
        
      } catch (e) {
        addMessage('‚úÖ Basic memory saved!', 'success');
        const memoryData = JSON.stringify(userMemory, null, 2);
        const blob = new Blob([memoryData], {type: 'application/json'});
        const url = URL.createObjectURL(blob);
        const a = document.createElement('a');
        a.href = url;
        a.download = `lilcuh_memory_${Date.now()}.json`;
        a.click();
        URL.revokeObjectURL(url);
      }
    }
    
  } catch (err) {
    removeMessage(thinking);
    addMessage('‚ùå Failed to create memory', 'error');
  }
}

function loadMemoryFile() {
  const input = document.createElement('input');
  input.type = 'file';
  input.accept = '.json';
  
  input.onchange = async (e) => {
    const file = e.target.files[0];
    if (!file) return;
    
    try {
      const text = await file.text();
      const loadedMemory = JSON.parse(text);
      
      if (loadedMemory.created && loadedMemory.lastUpdated) {
        userMemory = loadedMemory;
        
        if (loadedMemory.projects && loadedMemory.projects.length > 0) {
          projectMemory = loadedMemory.projects;
          updateMemory();
        }
        
        addMessage(`‚úÖ Memory restored! ${userMemory.name ? `Welcome back, ${userMemory.name}!` : 'Welcome back!'}\n\n- ${userMemory.importantFacts.length} facts\n- ${Object.keys(userMemory.preferences).length} preferences\n- ${projectMemory.length} projects`, 'success');
      } else {
        addMessage('‚ùå Invalid memory file', 'error');
      }
      
    } catch (err) {
      addMessage('‚ùå Failed to load memory file', 'error');
    }
  };
  
  input.click();
}

// Event listeners
sendBtn.addEventListener('click', send);
input.addEventListener('keydown', (e) => {
  if (e.key === 'Enter' && !e.shiftKey) {
    e.preventDefault();
    send();
  }
});

document.getElementById('createMemoryBtn').addEventListener('click', createMemoryFile);
document.getElementById('loadMemoryBtn').addEventListener('click', loadMemoryFile);
document.getElementById('clearMemBtn').addEventListener('click', clearMemory);
document.getElementById('showMemBtn').addEventListener('click', showMemory);
document.getElementById('exportBtn').addEventListener('click', exportCode);
document.getElementById('newProjBtn').addEventListener('click', newProject);
document.getElementById('copyCodeBtn').addEventListener('click', copyCode);
document.getElementById('closeCodeBtn').addEventListener('click', closeCode);
document.getElementById('refreshPreviewBtn').addEventListener('click', refreshPreview);
document.getElementById('closePreviewBtn').addEventListener('click', closePreview);

document.getElementById('webAccessBtn').addEventListener('click', () => {
  const url = prompt('üåê Enter URL to scrape:');
  if (url) scrapeWebsite(url);
});

document.getElementById('steamGuideBtn').addEventListener('click', () => {
  const game = prompt('üéÆ Enter Steam game name:');
  if (game) getSteamGuide(game);
});

document.getElementById('attachBtn').addEventListener('click', () => fileInput.click());
fileInput.addEventListener('change', (e) => {
  if (e.target.files.length) {
    handleFiles(e.target.files);
    e.target.value = '';
  }
});

document.getElementById('genImageBtn').addEventListener('click', () => generateMedia('image'));
document.getElementById('genVideoBtn').addEventListener('click', () => generateMedia('video'));
document.getElementById('genSoundBtn').addEventListener('click', () => generateMedia('sound'));

// Clock and Date
function updateClock() {
  const now = new Date();
  
  let hours = now.getHours();
  const minutes = now.getMinutes();
  const seconds = now.getSeconds();
  const ampm = hours >= 12 ? 'PM' : 'AM';
  
  hours = hours % 12;
  hours = hours ? hours : 12;
  
  const timeStr = `${String(hours).padStart(2, '0')}:${String(minutes).padStart(2, '0')}:${String(seconds).padStart(2, '0')} ${ampm}`;
  
  const months = ['Jan', 'Feb', 'Mar', 'Apr', 'May', 'Jun', 'Jul', 'Aug', 'Sep', 'Oct', 'Nov', 'Dec'];
  const days = ['Sun', 'Mon', 'Tue', 'Wed', 'Thu', 'Fri', 'Sat'];
  
  const dateStr = `${days[now.getDay()]}, ${months[now.getMonth()]} ${now.getDate()}, ${now.getFullYear()}`;
  
  document.getElementById('clock').textContent = timeStr;
  document.getElementById('date').textContent = dateStr;
}

updateClock();
setInterval(updateClock, 1000);

// Initial message
addMessage('üëã Yo! I\'m Lil Cuh - your ENHANCED ultra-intelligent AI!\n\n‚ú® NEW FEATURES:\nüîç Automatic code validation\nüåê Web scraping (type "scrape [url]")\nüéÆ Steam guides (type "steam [game]")\nüíª Elite code generation\n\nWhat can I help you with?', 'bot');
showSuggestions(['Build me a calculator', 'Scrape https://example.com', 'Steam Minecraft', 'Create a Todo app']);
updateMemory();
</script>
</body>
</html>
